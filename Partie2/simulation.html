<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Simulation M√©tro - 1 train par ligne</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: Arial, sans-serif;
            background: #1a1a2e;
            color: white;
            padding: 20px;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
            color: #4CAF50;
        }
        
        .subtitle {
            text-align: center;
            font-size: 1.2em;
            margin-bottom: 20px;
            color: #FFD700;
        }
        
        .controls {
            text-align: center;
            margin-bottom: 20px;
        }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            margin: 0 10px;
            transition: all 0.3s;
        }
        
        button:hover { 
            background: #45a049;
            transform: scale(1.05);
        }
        
        .main-content {
            display: flex;
            gap: 20px;
        }
        
        #canvas-container {
            flex: 2;
            background: #16213e;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        
        canvas {
            background: #0f1419;
            border-radius: 10px;
            display: block;
        }
        
        #sidebar {
            flex: 1;
            background: #16213e;
            border-radius: 15px;
            padding: 20px;
            max-height: 700px;
            overflow-y: auto;
        }
        
        .legend {
            margin-bottom: 20px;
        }
        
        .legend h3 {
            margin-bottom: 10px;
            color: #4CAF50;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            font-size: 14px;
        }
        
        .legend-color {
            width: 30px;
            height: 20px;
            border-radius: 4px;
            margin-right: 10px;
        }
        
        .event-log {
            margin-top: 20px;
        }
        
        .event-log h3 {
            margin-bottom: 10px;
            color: #4CAF50;
        }
        
        .log-entry {
            padding: 8px;
            margin: 5px 0;
            border-left: 3px solid;
            border-radius: 4px;
            font-size: 12px;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .status {
            text-align: center;
            padding: 10px;
            background: rgba(76, 175, 80, 0.2);
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .station-occupied {
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöá Simulation M√©tro Paris - Partie 2</h1>
        <p class="subtitle">‚ö†Ô∏è Exclusion Mutuelle : 1 train par ligne | Max 1 train par station</p>
        
        <div class="controls">
            <button onclick="startSimulation()">‚ñ∂ D√©marrer la simulation</button>
            <button onclick="resetSimulation()">üîÑ Recommencer</button>
            <button onclick="toggleSpeed()">‚ö° Vitesse: <span id="speed">Normal</span></button>
        </div>
        
        <div class="main-content">
            <div id="canvas-container">
                <canvas id="metroCanvas" width="1000" height="700"></canvas>
            </div>
            
            <div id="sidebar">
                <div class="status" id="status">
                    Cliquez sur "D√©marrer" pour lancer la simulation
                </div>
                
                <div class="legend">
                    <h3>üìç L√©gende des Lignes</h3>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #2196F3;"></div>
                        <span>Ligne Bleue (B ‚Üí C ‚Üí I)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #f44336;"></div>
                        <span>Ligne Rouge (E ‚Üí F ‚Üí G ‚Üí H ‚Üí I ‚Üí J)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #795548;"></div>
                        <span>Ligne Marron (D ‚Üí K)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #4CAF50;"></div>
                        <span>Ligne Verte (A ‚Üí P ‚Üí L ‚Üí G ‚Üí M ‚Üí N ‚Üí O)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #9E9E9E;"></div>
                        <span>Ligne Noire (M ‚Üí V)</span>
                    </div>
                </div>
                
                <div class="event-log">
                    <h3>üìã Journal des √©v√©nements</h3>
                    <div id="logs"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const canvas = document.getElementById('metroCanvas');
        const ctx = canvas.getContext('2d');
        
        let events = [];
        let currentIndex = 0;
        let animationSpeed = 300;
        let running = false;
        
        // D√©finition des positions des stations
        const stations = {
            'A': {x: 100, y: 100},
            'B': {x: 200, y: 400},
            'C': {x: 350, y: 400},
            'D': {x: 150, y: 600},
            'E': {x: 100, y: 250},
            'F': {x: 200, y: 250},
            'G': {x: 400, y: 250},
            'H': {x: 500, y: 300},
            'I': {x: 500, y: 400},
            'J': {x: 600, y: 450},
            'K': {x: 200, y: 600},
            'L': {x: 300, y: 150},
            'M': {x: 550, y: 200},
            'N': {x: 650, y: 200},
            'O': {x: 750, y: 200},
            'P': {x: 200, y: 100},
            'V': {x: 550, y: 100}
        };
        
        // Trajets des lignes
        const trajets = {
            'Bleue': ['B', 'C', 'I'],
            'Rouge': ['E', 'F', 'G', 'H', 'I', 'J'],
            'Marron': ['D', 'K'],
            'Verte': ['A', 'P', 'L', 'G', 'M', 'N', 'O'],
            'Noire': ['M', 'V']
        };
        
        // √âtat des stations
        let stationsOccupees = {};
        
        // M√©tros actifs (UN SEUL PAR LIGNE)
        let metros = {
            'Bleue-1': null,
            'Rouge-1': null,
            'Marron-1': null,
            'Verte-1': null,
            'Noire-1': null
        };
        
        const colors = {
            'Bleue': '#2196F3',
            'Rouge': '#f44336',
            'Marron': '#795548',
            'Verte': '#4CAF50',
            'Noire': '#9E9E9E'
        };
        
        function drawNetwork() {
            ctx.fillStyle = '#0f1419';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Dessiner les connexions
            ctx.strokeStyle = '#444';
            ctx.lineWidth = 3;
            
            const connections = [
                ['B','C'], ['C','I'], ['E','F'], ['F','G'], ['G','H'],
                ['H','I'], ['I','J'], ['D','K'], ['A','P'], ['P','L'],
                ['L','G'], ['G','M'], ['M','N'], ['N','O'], ['M','V']
            ];
            
            connections.forEach(([s1, s2]) => {
                ctx.beginPath();
                ctx.moveTo(stations[s1].x, stations[s1].y);
                ctx.lineTo(stations[s2].x, stations[s2].y);
                ctx.stroke();
            });
            
            // Dessiner les stations
            Object.entries(stations).forEach(([name, pos]) => {
                ctx.beginPath();
                ctx.arc(pos.x, pos.y, 20, 0, Math.PI * 2);
                
                // Changer la couleur si la station est occup√©e
                if (stationsOccupees[name]) {
                    ctx.fillStyle = '#ff6b6b';
                } else {
                    ctx.fillStyle = '#1e3c72';
                }
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 16px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(name, pos.x, pos.y);
            });
            
            // Dessiner les m√©tros
            Object.entries(metros).forEach(([id, metro]) => {
                if (metro) {
                    ctx.beginPath();
                    ctx.arc(metro.x, metro.y, 12, 0, Math.PI * 2);
                    ctx.fillStyle = colors[metro.ligne];
                    ctx.fill();
                    ctx.strokeStyle = '#fff';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    
                    // ID du m√©tro
                    ctx.fillStyle = '#fff';
                    ctx.font = 'bold 10px Arial';
                    ctx.fillText(metro.id, metro.x, metro.y);
                }
            });
        }
        
        async function startSimulation() {
            if (running) return;
            
            try {
                const response = await fetch('events.json');
                events = await response.json();
                events = events.filter(e => e.time);
                
                running = true;
                currentIndex = 0;
                metros = {
                    'Bleue-1': null,
                    'Rouge-1': null,
                    'Marron-1': null,
                    'Verte-1': null,
                    'Noire-1': null
                };
                stationsOccupees = {};
                document.getElementById('status').textContent = 'üöÄ Simulation en cours...';
                document.getElementById('logs').innerHTML = '';
                
                drawNetwork();
                playEvents();
            } catch (error) {
                alert('Erreur: Lancez d\'abord ./metro_graphique pour g√©n√©rer events.json');
            }
        }
        
        function playEvents() {
            if (!running || currentIndex >= events.length) {
                running = false;
                document.getElementById('status').textContent = '‚úÖ Simulation termin√©e';
                return;
            }
            
            const event = events[currentIndex++];
            processEvent(event);
            
            setTimeout(playEvents, animationSpeed);
        }
        
        function processEvent(event) {
            const metroId = `${event.ligne}-${event.id}`;
            let metro = metros[metroId];
            
            if (event.action === 'DEPART') {
                const firstStation = event.station;
                metro = {
                    id: metroId,
                    ligne: event.ligne,
                    x: stations[firstStation].x,
                    y: stations[firstStation].y,
                    currentStation: firstStation
                };
                metros[metroId] = metro;
                stationsOccupees[firstStation] = metroId;
            }
            
            if (event.action === 'QUITTE' && event.station) {
                delete stationsOccupees[event.station];
            }
            
            if (event.action === 'ARRIVE' && metro && event.station) {
                metro.x = stations[event.station].x;
                metro.y = stations[event.station].y;
                metro.currentStation = event.station;
                stationsOccupees[event.station] = metroId;
            }
            
            if (event.action === 'TERMINE') {
                metros[metroId] = null;
                if (event.station) {
                    delete stationsOccupees[event.station];
                }
            }
            
            addLogEntry(event);
            drawNetwork();
        }
        
        function addLogEntry(event) {
            const logsDiv = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.style.borderColor = colors[event.ligne];
            entry.style.background = colors[event.ligne] + '20';
            
            let message = '';
            switch(event.action) {
                case 'DEPART':
                    message = `üöÄ ${event.ligne} d√©marre de ${event.station}`;
                    break;
                case 'TRAJET':
                    message = `üöÑ ${event.ligne} en trajet ${event.station}`;
                    break;
                case 'ATTEND':
                    message = `‚è≥ ${event.ligne} attend ${event.station}`;
                    break;
                case 'ARRIVE':
                    message = `‚úì ${event.ligne} arrive √† ${event.station}`;
                    break;
                case 'QUITTE':
                    message = `‚û°Ô∏è ${event.ligne} quitte ${event.station}`;
                    break;
                case 'TERMINE':
                    message = `üèÅ ${event.ligne} termine`;
                    break;
            }
            
            entry.textContent = `[${event.time}] ${message}`;
            
            logsDiv.insertBefore(entry, logsDiv.firstChild);
            
            while (logsDiv.children.length > 15) {
                logsDiv.removeChild(logsDiv.lastChild);
            }
        }
        
        function resetSimulation() {
            running = false;
            currentIndex = 0;
            metros = {
                'Bleue-1': null,
                'Rouge-1': null,
                'Marron-1': null,
                'Verte-1': null,
                'Noire-1': null
            };
            stationsOccupees = {};
            document.getElementById('status').textContent = 'Cliquez sur "D√©marrer" pour lancer la simulation';
            document.getElementById('logs').innerHTML = '';
            drawNetwork();
        }
        
        function toggleSpeed() {
            if (animationSpeed === 300) {
                animationSpeed = 100;
                document.getElementById('speed').textContent = 'Rapide';
            } else if (animationSpeed === 100) {
                animationSpeed = 50;
                document.getElementById('speed').textContent = 'Tr√®s rapide';
            } else {
                animationSpeed = 300;
                document.getElementById('speed').textContent = 'Normal';
            }
        }
        
        // Initialiser
        drawNetwork();
    </script>
</body>
</html>
